services:
  api:
    ports:
      - "127.0.0.1:8000:8000"  # Localhost only — ngrok or Nginx handles public access
    environment:
      ENVIRONMENT: production
      DEBUG: "false"
      DB_POOL_SIZE: ${DB_POOL_SIZE:-5}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-5}
      DB_POOL_TIMEOUT: ${DB_POOL_TIMEOUT:-15}
      DB_POOL_RECYCLE: ${DB_POOL_RECYCLE:-900}
      ENABLE_INTEGRATION_API: ${ENABLE_INTEGRATION_API:-false}
      ENABLE_INTEGRATION_DELIVERY: ${ENABLE_INTEGRATION_DELIVERY:-false}
      INTEGRATION_ENCRYPTION_KEY_CURRENT: ${INTEGRATION_ENCRYPTION_KEY_CURRENT:-}
      INTEGRATION_ENCRYPTION_KEY_PREVIOUS: ${INTEGRATION_ENCRYPTION_KEY_PREVIOUS:-}
      INTEGRATION_DEFAULT_RATE_LIMIT_PER_HOUR: ${INTEGRATION_DEFAULT_RATE_LIMIT_PER_HOUR:-1000}
      INTEGRATION_FEED_CACHE_TTL: ${INTEGRATION_FEED_CACHE_TTL:-900}
      INTEGRATION_WEBHOOK_TIMEOUT_SECONDS: ${INTEGRATION_WEBHOOK_TIMEOUT_SECONDS:-5}
      INTEGRATION_DELIVERY_RETENTION_DAYS: ${INTEGRATION_DELIVERY_RETENTION_DAYS:-30}
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  celery-worker:
    environment:
      ENVIRONMENT: production
      DEBUG: "false"
      DB_POOL_SIZE: ${DB_POOL_SIZE:-5}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-5}
      DB_POOL_TIMEOUT: ${DB_POOL_TIMEOUT:-15}
      DB_POOL_RECYCLE: ${DB_POOL_RECYCLE:-900}
      ENABLE_INTEGRATION_API: ${ENABLE_INTEGRATION_API:-false}
      ENABLE_INTEGRATION_DELIVERY: ${ENABLE_INTEGRATION_DELIVERY:-false}
      INTEGRATION_ENCRYPTION_KEY_CURRENT: ${INTEGRATION_ENCRYPTION_KEY_CURRENT:-}
      INTEGRATION_ENCRYPTION_KEY_PREVIOUS: ${INTEGRATION_ENCRYPTION_KEY_PREVIOUS:-}
      INTEGRATION_DEFAULT_RATE_LIMIT_PER_HOUR: ${INTEGRATION_DEFAULT_RATE_LIMIT_PER_HOUR:-1000}
      INTEGRATION_FEED_CACHE_TTL: ${INTEGRATION_FEED_CACHE_TTL:-900}
      INTEGRATION_WEBHOOK_TIMEOUT_SECONDS: ${INTEGRATION_WEBHOOK_TIMEOUT_SECONDS:-5}
      INTEGRATION_DELIVERY_RETENTION_DAYS: ${INTEGRATION_DELIVERY_RETENTION_DAYS:-30}
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  celery-beat:
    environment:
      ENVIRONMENT: production
      DEBUG: "false"
      DB_POOL_SIZE: ${DB_POOL_SIZE:-5}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-5}
      DB_POOL_TIMEOUT: ${DB_POOL_TIMEOUT:-15}
      DB_POOL_RECYCLE: ${DB_POOL_RECYCLE:-900}
      ENABLE_INTEGRATION_API: ${ENABLE_INTEGRATION_API:-false}
      ENABLE_INTEGRATION_DELIVERY: ${ENABLE_INTEGRATION_DELIVERY:-false}
      INTEGRATION_ENCRYPTION_KEY_CURRENT: ${INTEGRATION_ENCRYPTION_KEY_CURRENT:-}
      INTEGRATION_ENCRYPTION_KEY_PREVIOUS: ${INTEGRATION_ENCRYPTION_KEY_PREVIOUS:-}
      INTEGRATION_DEFAULT_RATE_LIMIT_PER_HOUR: ${INTEGRATION_DEFAULT_RATE_LIMIT_PER_HOUR:-1000}
      INTEGRATION_FEED_CACHE_TTL: ${INTEGRATION_FEED_CACHE_TTL:-900}
      INTEGRATION_WEBHOOK_TIMEOUT_SECONDS: ${INTEGRATION_WEBHOOK_TIMEOUT_SECONDS:-5}
      INTEGRATION_DELIVERY_RETENTION_DAYS: ${INTEGRATION_DELIVERY_RETENTION_DAYS:-30}
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  frontend:
    ports:
      - "127.0.0.1:8501:8501"
    environment:
      DEBUG: "false"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

